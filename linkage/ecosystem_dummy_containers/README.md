# Dummy containers for ecosystem development

These containers perform a simple transformation to their input data,
to stand in for the kinds of operations that would be done in a step of entity resolution.
The key reason to use these dummy containers is that they have the property that their
input and their output follow the same schema; their output can be passed back in to another
one of these dummy containers, ad infinitum.
Therefore if we ignore what is going on inside the containers, we can build
pipelines of arbitrary length and complexity out of these containers.

Specifically, the input and output of these containers is a dataframe
with columns "foo," "bar," "counter," and optionally up to 5 columns of
the form "added_column_{i}" where i is an integer.
This can be in CSV or Parquet format.
Initial input files are generated by the notebook in this directory.

There are four containers provided here:

- python_pandas uses Pandas.
- python_pyspark uses Spark from Python. The Spark master URL can be configured with DUMMY_STEP_SPARK_MASTER_URL.
- r uses R and tidyverse packages.
- python_pandas_broken also uses Pandas, but intentionally implements the "contract" of this step incorrectly, returning the wrong columns.
  This can be useful for testing the error case.

All containers can be configured with environment variables:

- DUMMY_STEP_INPUT_FILE_TYPE (optional; defaults to parquet) should be "parquet" or "csv" and indicates how to parse the input file
- DUMMY_STEP_INPUT_PATH (required) is a path in the container's file system to the input file
- DUMMY_STEP_OUTPUT_FILE_TYPE (optional; defaults to parquet) should be "parquet" or "csv" and indicates how to write the output
- DUMMY_STEP_OUTPUT_PATH (required) is a full file path to save the output to within the container's file system

There are instructions to build and run these containers with both Docker and Singularity.
Go to the individual container directories for these.

`test.py` is a script that demonstrates the output-is-valid-input property of these containers by iterating
30 random containers in a row, randomly choosing between CSV and parquet, each taking the output of the previous.
Instructions for running this test are below.

## To run the test with Docker

```
bash docker-build.sh
DUMMY_STEP_TEST_CONTAINER_ENGINE=docker python test.py
```

or, to go to .tar.gz and back:

```
bash docker-build.sh
bash docker-save.sh
DUMMY_STEP_TEST_CONTAINER_ENGINE=docker DUMMY_STEP_TEST_FROM_TAR=true python test.py
```

## To run the test with Singularity

Install [`spython` from PyPI](https://github.com/singularityhub/singularity-cli). Then:

```
bash singularity-build-direct.sh
python test.py
```

or, to build via Docker's .tar.gz:

```
bash docker-build.sh
bash docker-save.sh
bash singularity-build-indirect.sh
python test.py
```